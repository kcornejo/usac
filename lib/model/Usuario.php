<?php

/**
 * Skeleton subclass for representing a row from the 'usuario' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * Fri Sep 20 13:26:47 2013
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Usuario extends BaseUsuario {

    public function save(PropelPDO $con = null) {
        $BitacoraCambios = new BitacoraCambios();
        $BitacoraCambios->setModelo('Usuario');
        $BitacoraCambios->setIp(sfContext::getInstance()->getRequest()->getRemoteAddress());
        if ($this->isNew()) {
            $clave = $this->getClave();
            $this->setClave(sha1($clave));
            $BitacoraCambios->setDescripcion('Creacion de Usuario: ' . $this->getUsuario());
        } else {
            $clave = $this->getClave();
            $this->setClave($clave);
            $BitacoraCambios->setDescripcion('Modificacion de Usuario: ' . $this->getUsuario());
        }
        $Usuario = UsuarioQuery::create()->findOneById(sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad'));
        if ($Usuario) {
            $BitacoraCambios->setCreatedBy($Usuario->getUsuario());
        }
        $BitacoraCambios->save();
        return parent::save($con);
    }

    public function getDetalleCompleto() {

        $msg = $this->getUsuario() . " | " . $this->getNombre() . " " . $this->getApellido();
        return $msg;
    }

    static function generaArbol($id) {
        $html = '';
        $Menu = MenuQuery::create()
                ->orderByOrden()
                ->where("superior IS NULL or superior = ''")
                ->usePerfilMenuQuery()
                ->usePerfilQuery()
                ->useUsuarioQuery()
                ->filterById($id)
                ->endUse()
                ->endUse()
                ->endUse()
                ->find();
        foreach ($Menu as $fila) {
            $html .= '<li class="dropdown">';
            $Detalle = MenuQuery::create()
                    ->filterBySuperior($fila->getId())
                    ->orderByOrden()
                    ->usePerfilMenuQuery()
                    ->usePerfilQuery()
                    ->useUsuarioQuery()
                    ->filterById($id)
                    ->endUse()
                    ->endUse()
                    ->endUse()
                    ->find();
            if (sizeof($Detalle) > 0) {
                $html .= '<a href="#" class="dropdown-toggle" data-toggle="dropdown">' . $fila->getDescripcion() . ' <span class="caret"></span></a>';
                $html .= '<ul class="dropdown-menu" role="menu">';
            } else {
                $html .= '<a href="' . sfContext::getInstance()->getController()->genUrl($fila->getModulo() . '/' . $fila->getAccion()) . '">' . $fila->getDescripcion() . ' <span class="caret"></span></a>';
            }
            foreach ($Detalle as $d) {
                sfContext::getInstance()->getUser()->addCredential($d->getModulo());
                $html .='<li class="">';
                $html.='<a href="' . sfContext::getInstance()->getController()->genUrl($d->getModulo() . '/' . $d->getAccion()) . '">';
                $html .='<i class="' . $d->getIcono() . '"></i> <span>' . $d->getDescripcion() . '</span>';
                $html .='</a>';
                $html .= '</li>';
            }
            if (sizeof($Detalle) > 0) {
                $html .= '</ul>';
            }
            $html .='</li>';
        }
        return $html;
    }

}
